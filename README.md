# Курсовой проект по предмету Информационные системы и базы данных

## Предметная область

В **Мире Стержня** есть магия. Магия подразделяется на **истинную** и **очевидную**. 

При этом очевидная магия делится на **чёрную** и **белую**, а также разделяется по ступеням с 1 до 234. Очевидная магия истощает силы сердца Мира, поэтому её использование ограничено и превышение дозволенных **Кодексом Хрембера** ступеней этой магии считается преступлением. 

В городе Ехо находится **тайное сыскное войско** и полиция Соединённого Королевства, которые следят за соблюдением порядка и Кодеса Хрембера в государстве. В частности расследуют преступления, которые происходят в Мире Стержня или касаются его. Преступления могут совершаться с помощью магии или без неё, преступления без применения магии лежат в зоне ответственности полиции, а магическими преступлениями занимается тайное сыскное войско, и именно они хранятся в архиве. Преступниками могут быть как люди самостоятельно изучившие магию, так и члены **магических орденов**. 

В орденах у людей есть чёткая градация по рангам: **послушник**, **младший магистр**, **старший магистр** и **великий магистр** (глава ордена). Отдельно в ордене могут присутствовать женщины, они не подвергаются стандартной ранговой системе. 

Преступления обычно расследуют несколько членов тайного сыскного войска (хотя может быть и один), среди них есть кто-то главный, на котором лежит большая ответственность за раскрытие дела.

Преступления на то и преступления, что из-за них кто-то страдает. В первую очередь от преступлений, совершенных с помощью магии, страдает сердце Мира. Задача тайного сыска - не дать подняться уровню урона за месяц выше порогового значения. Если это не удается, то это влияет на их премию в худшую сторону. Также от преступлений страдают другие жители мира. Если житель за год был жертвой в 10 и более преступлениях, то в конце года ему выплачивается пособие.

Наказания за преступления зависят от их тяжести. Самым страшным наказанием считается заключение в тюрьму **Нунду**. После него идёт ссылка из государства или заключение в тюрьму **Холоми**, расположенную в центре Мира, но не дающую заключённым колдовать внутри. Возможны заключения и в другие тюрьмы или исправительные работы. За малые нарушения граждане Королевства могут отделаться штрафом в королевскую казну. Штраф может совмещаться со ссылкой или заключением.

За удачно закрытое преступление сотрудники тайного сыскного войска могут получить премию, а также несколько **дней свободы от забот** (отпуска).

У Мира Стержня кроме физической стороны, в которой живёт большая часть людей, существует **тёмная сторона**, куда могут проникнуть только могущественные маги. Также из этого Мира можно попасть в **Хумгад** - коридор между мирами. Преступления могут совершаться во всех этих локациях, потому что могущественные маги часто любят нарушать правила.

В Мире Стержня кроме людей живёт ещё много разных рас, например, эльфы, оборотни, гномы, великаны и их всевозможные комбинации, поскольку любви покорны все, а времени с сотворения Мира прошло немало.


## Сценарии использования базы данных

**Роль: Летописец**
- просмотр всех сущностей кроме пользователей и их прав, ставок премий и пособий;
- создание/обновление/удаление всех сущностей кроме пользователей и их прав, ставок премий и пособий.

**Роль: Детектив**
- просмотр всех сущностей кроме пользователей и их прав, чужих ставок премий и пособий;
- просмотр рассчитанной ему на этот момент премии за текущий год;
- просмотр урона сердцу за этот месяц и сколько осталось до лимита;
- просмотр статистики по урону сердцу мира за прошлые месяцы.

**Роль: Читатель**
- просматривать у дел только названия и их описания;
- просматривать список локаций;
- просматривать список детективов;
- просматривать заклинания очевидной магии;
- просматривать словарь рангов в ордене;
- просматривать названия орденов.

**Роль: Казначей**
- получать статистику по пособиям за выбранный промежуток времени;
- получать статистику по премиям за выбранный промежуток времени;
- редактирование ставок премий и пособий;
- просмотр списка детективов и существ.

**Для реализации были выбраны роли Летописец и Детектив**

## Модули проекта

### api
Проект писался c использованием подхода ApiFirst. Так что первым делом
была разработана спецификация api - api/src/main/resources/openapi.json.
В ней описаны все конечные точки. Для верификации спеки использовался gradle плагин
org.openapi.generator, таска openApiValidate.

Для визуализации api-спецификации и помощи в дальнейшей независимой разработки
фронтенда и бекенда использовались моки сервера и интерфейса.

**Мок сервера**

Был выбран Fakeit (https://github.com/justinfeng/fakeit), так как не требовал заполненных полей examples,
а также поддерживал большинство функций и доступен в виде докер-образа. Однако был обнаружен недостаток, что
он не игнорирует в переданном на запрос dto поля, помеченные как readOnly. Из-за чего на корректный для основного
сервера запрос он отдавал 418 код ответа и ошибку. Для применения изменений спецификации необходим рестарт.

Запуск мока из windows(на порту 8080):

    ../databases/api/src/main/resources> docker run -t -v %cd%\openapi.json:/home/openapi.json -p 8080:8080 realfengjia/fakeit:latest --spec /home/openapi.json

Другие варианты моков сервера можно посмотреть здесь https://openapi.tools/#mock

**Мок интерфейса**

Использовался swagger-ui(https://github.com/swagger-api/swagger-ui). Изменения спецификации подхватываются "на лету", в крайнем
случае при обновлении страницы. Досупен по http://localhost/#. Можно менять сервер через выпадающее меню над конечными точками.

Запуск мока из windows:

    ../databases/api/src/main/resources> docker run -p 80:8080 -e SWAGGER_JSON=/foo/swagger.json -v %cd%\openapi.json:/foo/swagger.json swaggerapi/swagger-ui

Пример интерфейса:

![Пример интерфейса](/docs/img/swagger.PNG "Пример интерфейса")

### backend

Стек: kotlin, spring, liquibase. Использует авторизацию по jwt-токену, который можно получить по логину/паролю из ручки `/api/v1/auth` (самописный велосипед на Spring Secutiry и JavaJsonWebToken).
Для соответствия OpenAPI спецификации контроллеры и dto генерировались по ней с помощью gradle-плагина org.openapi.generator, таска openApiGenerate.

Для запуска необходима jre 14 и поднятая на localhost:5432 база данных "secret_archive" под управлением PostgreSQL, с пользователем "postgres" и паролем "password", обладающим паролем "password".
В неё автоматически добавится пользователь приложения с правами "Летописец" - логин "luukfi_pentz", пароль "admin".
И пользователь с правами "Детектив" - логин "kofa_yox", пароль "amamam". А также некоторое количество данных для примера. Все это выполняется с помощью liquibase.

**Способ запустить 1 (простой и неконфигурируемый):**

Достаточно скачать файл backend/build/libs/backend-0.0.1-SNAPSHOT.jar
и выполнить в том месте, куда скачали файл, команду:

    java -jar backend-0.0.1-SNAPSHOT.jar

**Способ запустить 2 (с возможностью что-то поправить):**

Также понадобится jdk 14 версии. 
Склонируйте/скачайте репозиторий (весь или только модуль backend).
Внестие желаемые изменения, перейдите в командной строке в папку backend и выполните для Windows:

    gradlew.bat bootRun

Для Linux:

    gradlew bootRun

### frontend
